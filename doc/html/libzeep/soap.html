<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Creating a SOAP and REST server</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../index.html" title="libzeep 3.0">
<link rel="up" href="../index.html" title="libzeep 3.0">
<link rel="prev" href="intro.html" title="Introduction">
<link rel="next" href="webapp.html" title="Creating a Web Application">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="spirit-nav">
<a accesskey="p" href="intro.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="webapp.html"><img src="../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="libzeep.soap"></a><a class="link" href="soap.html" title="Creating a SOAP and REST server">Creating a SOAP and REST server</a>
</h2></div></div></div>
<div class="toc"><dl class="toc">
<dt><span class="section"><a href="soap.html#libzeep.soap.intro">Introduction</a></span></dt>
<dt><span class="section"><a href="soap.html#libzeep.soap.basics">A real world example</a></span></dt>
</dl></div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="libzeep.soap.intro"></a><a class="link" href="soap.html#libzeep.soap.intro" title="Introduction">Introduction</a>
</h3></div></div></div>
<p>
        SOAP and REST are two ways to export functionality over the web. Both have
        their strongness and weakness. SOAP enforces a strict type checking on input
        and output parameters. It works with a formal description file called WSDL
        that specifies all the exposed functionality and how to invoke this. Many
        tools exist that can read WSDL files and create client code that uses the
        exposed functions.
      </p>
<p>
        REST on the other hand, is much easier to use ad hoc. It passes the arguments
        to the invoked functions in the URL and uses standard GET, POST and PUT methods
        of the HTTP protocol.
      </p>
<p>
        libzeep is mainly focussed to using SOAP, but allows to access the exported
        functionality in a REST like way. Not all functions can be accessed this
        way, if the input parameters are some complex type, you're out of luck. This
        documentation will focus on SOAP, but if the function is simple, you can
        test it using REST from a browser.
      </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="libzeep.soap.basics"></a><a class="link" href="soap.html#libzeep.soap.basics" title="A real world example">A real world example</a>
</h3></div></div></div>
<p>
        Creating a SOAP server using libzeep is very easy. The bulk of the work is
        done by libzeep, you only have to specify what methods to expose and optionally
        what datatypes.
      </p>
<p>
        To demonstrate this, we will create a simple SOAP server that allows the
        client to search for documents in a databank. Lets start with the initial
        code, the declaration of our server object.
      </p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">zeep</span><span class="special">/</span><span class="identifier">server</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">std</span><span class="special">;</span>

<span class="keyword">class</span> <span class="identifier">MyServer</span> <span class="special">:</span> <span class="keyword">public</span> <code class="computeroutput"><a class="link" href="../zeep/server.html" title="Class server">zeep::server</a></code>
<span class="special">{</span>
  <span class="keyword">public</span><span class="special">:</span>

    <span class="keyword">struct</span> <span class="identifier">MyHit</span>
    <span class="special">{</span>
      <span class="keyword">long</span>   <span class="identifier">id</span><span class="special">;</span>
      <span class="keyword">float</span>  <span class="identifier">score</span><span class="special">;</span>
      <span class="identifier">string</span> <span class="identifier">title</span><span class="special">;</span>

      <span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">Archive</span><span class="special">&gt;</span>
      <span class="keyword">void</span> <span class="identifier">serialize</span><span class="special">(</span><span class="identifier">Archive</span><span class="special">&amp;</span> <span class="identifier">ar</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="identifier">version</span><span class="special">)</span>
      <span class="special">{</span>
        <span class="identifier">ar</span> <span class="special">&amp;</span> <span class="identifier">BOOST_SERIALIZATION_NVP</span><span class="special">(</span><span class="identifier">id</span><span class="special">)</span> <span class="special">&amp;</span> <span class="identifier">BOOST_SERIALIZATION_NVP</span><span class="special">(</span><span class="identifier">score</span><span class="special">)</span> <span class="special">&amp;</span> <span class="identifier">BOOST_SERIALIZATION_NVP</span><span class="special">(</span><span class="identifier">title</span><span class="special">);</span>
      <span class="special">}</span>
    <span class="special">};</span>

    <span class="keyword">enum</span> <span class="identifier">MyAlgorithm</span>
    <span class="special">{</span>
      <span class="identifier">algVector</span><span class="special">,</span> <span class="identifier">algDice</span><span class="special">,</span> <span class="identifier">algJaccard</span>
    <span class="special">};</span>

    <span class="identifier">MyServer</span><span class="special">();</span>

    <span class="keyword">void</span> <span class="identifier">CountDocuments</span><span class="special">(</span><span class="keyword">long</span><span class="special">&amp;</span> <span class="identifier">outCount</span><span class="special">);</span>
    <span class="keyword">void</span> <span class="identifier">GetDocument</span><span class="special">(</span><span class="keyword">long</span> <span class="identifier">inID</span><span class="special">,</span> <span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">outDocument</span><span class="special">);</span>
    <span class="keyword">void</span> <span class="identifier">FindDocument</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;&amp;</span> <span class="identifier">inTerms</span><span class="special">,</span> <span class="identifier">MyAlgorithm</span> <span class="identifier">inAlgorithm</span><span class="special">,</span>
    <span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">MyHit</span><span class="special">&gt;&amp;</span> <span class="identifier">outResponse</span><span class="special">);</span>
<span class="special">};</span>
</pre>
<p>
        Nothing special so far. Apart from inheriting from <code class="computeroutput"><a class="link" href="../zeep/server.html" title="Class server">zeep::server</a></code>, this code could have
        been code you already had lying around. The addition of the <code class="computeroutput"><span class="identifier">serialize</span></code> method to <code class="computeroutput"><span class="identifier">MyHit</span></code>
        may also have been new to the code. The implementation of the actual server
        methods are also straightforward:
      </p>
<pre class="programlisting"><span class="keyword">void</span> <span class="identifier">MyServer</span><span class="special">::</span><span class="identifier">CountDocuments</span><span class="special">(</span><span class="keyword">long</span><span class="special">&amp;</span> <span class="identifier">outCount</span><span class="special">)</span>
<span class="special">{</span>
  <span class="keyword">long</span> <span class="identifier">count</span> <span class="special">=</span> <span class="number">1</span><span class="special">;</span> 	<span class="comment">// real code should return something more sensible of course</span>
  <span class="identifier">outCount</span> <span class="special">=</span> <span class="identifier">count</span><span class="special">;</span>
<span class="special">}</span>

<span class="keyword">void</span> <span class="identifier">MyServer</span><span class="special">::</span><span class="identifier">GetDocument</span><span class="special">(</span><span class="keyword">long</span> <span class="identifier">inID</span><span class="special">,</span> <span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">outDocument</span><span class="special">)</span>
<span class="special">{</span>
  <span class="keyword">if</span> <span class="special">(</span><span class="identifier">inID</span> <span class="special">==</span> <span class="number">1</span><span class="special">)</span>
    <span class="identifier">outDocument</span> <span class="special">=</span> <span class="string">"The first document!"</span><span class="special">;</span>
  <span class="keyword">else</span>
    <span class="keyword">throw</span> <span class="identifier">zeep</span><span class="special">::</span><span class="identifier">exception</span><span class="special">(</span><span class="string">"document %ld not found"</span><span class="special">,</span> <span class="identifier">inID</span><span class="special">);</span>
<span class="special">}</span>

<span class="keyword">void</span> <span class="identifier">MyServer</span><span class="special">::</span><span class="identifier">FindDocument</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;&amp;</span> <span class="identifier">inTerms</span><span class="special">,</span>
  <span class="identifier">MyAlgorithm</span> <span class="identifier">inAlgorithm</span><span class="special">,</span> <span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">MyHit</span><span class="special">&gt;&amp;</span> <span class="identifier">outResponse</span><span class="special">)</span>
<span class="special">{</span>
  <span class="keyword">if</span> <span class="special">(</span><span class="identifier">inTerms</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">==</span> <span class="number">1</span> <span class="keyword">and</span> <span class="identifier">inAlgorithm</span> <span class="special">==</span> <span class="identifier">algVector</span><span class="special">)</span>
  <span class="special">{</span>
    <span class="identifier">MyHit</span> <span class="identifier">hit</span> <span class="special">=</span> <span class="special">{</span> <span class="number">1</span><span class="special">,</span> <span class="number">1.0f</span><span class="special">,</span> <span class="string">"The first hit"</span> <span class="special">};</span>
    <span class="identifier">outResponse</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">hit</span><span class="special">);</span>
  <span class="special">}</span>
<span class="special">}</span>
</pre>
<p>
        Not very useful code, but it gives you an idea how simple it is to create
        a server. You don't have to do anything special, it's still code you could
        have written for some other purpose. Note that the GetDocument method throws
        an exception. The result in a SOAP server will be a SOAP Fault being returned
        containing the text 'document x not found'.
      </p>
<p>
        Unfortunately, this is not all that needs to be done, we still have to tell
        libzeep what methods and what datatypes to expose. That's what we do in the
        constructor for <code class="computeroutput"><span class="identifier">MyServer</span></code>.
      </p>
<pre class="programlisting"><span class="identifier">MyServer</span><span class="special">::</span><span class="identifier">MyServer</span><span class="special">()</span>
  <span class="special">:</span> <code class="computeroutput"><a class="link" href="../zeep/server.html" title="Class server">zeep::server</a></code><span class="special">(</span><span class="string">"http://www.example.org/MyServer"</span><span class="special">,</span> <span class="string">"searchMyServer"</span><span class="special">)</span>
<span class="special">{</span>
  <span class="comment">// first export the data types, start with MyHit</span>
  <span class="identifier">zeep</span><span class="special">::</span><span class="identifier">xml</span><span class="special">::</span><span class="identifier">serialize_struct</span><span class="special">&lt;</span><span class="identifier">MyHit</span><span class="special">&gt;::</span><span class="identifier">set_struct_name</span><span class="special">(</span><span class="string">"hit"</span><span class="special">);</span>

  <span class="comment">// and then the MyAlgorithm enum</span>
  <span class="identifier">zeep</span><span class="special">::</span><span class="identifier">xml</span><span class="special">::</span><span class="identifier">enum_map</span><span class="special">&lt;</span><span class="identifier">MyAlgorithm</span><span class="special">&gt;::</span><span class="identifier">instance</span><span class="special">(</span><span class="string">"algorithm"</span><span class="special">).</span><span class="identifier">add_enum</span><span class="special">()</span>
    <span class="special">(</span><span class="string">"vector"</span><span class="special">,</span> <span class="identifier">algVector</span><span class="special">)</span>
    <span class="special">(</span><span class="string">"dice"</span><span class="special">,</span> <span class="identifier">algDice</span><span class="special">)</span>
    <span class="special">(</span><span class="string">"jaccard"</span><span class="special">,</span> <span class="identifier">algJaccard</span><span class="special">);</span>

  <span class="comment">// Now export the methods, start with CountDocuments</span>
  <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">kCountDocumentsParamNames</span><span class="special">[]</span> <span class="special">=</span> <span class="special">{</span> <span class="string">"response"</span> <span class="special">};</span>
  <span class="identifier">register_action</span><span class="special">(</span><span class="string">"CountDocuments"</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">MyServer</span><span class="special">::</span><span class="identifier">CountDocuments</span><span class="special">,</span> <span class="identifier">kCountDocumentsParamNames</span><span class="special">);</span>

  <span class="comment">// then GetDocument</span>
  <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">kGetDocumentParamNames</span><span class="special">[]</span> <span class="special">=</span> <span class="special">{</span> <span class="string">"id"</span><span class="special">,</span> <span class="string">"response"</span> <span class="special">};</span>
  <span class="identifier">register_action</span><span class="special">(</span><span class="string">"GetDocument"</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">MyServer</span><span class="special">::</span><span class="identifier">GetDocument</span><span class="special">,</span> <span class="identifier">kGetDocumentParamNames</span><span class="special">);</span>

  <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">kFindDocumentParamNames</span><span class="special">[]</span> <span class="special">=</span> <span class="special">{</span> <span class="string">"terms"</span><span class="special">,</span> <span class="string">"algorithm"</span><span class="special">,</span> <span class="string">"response"</span> <span class="special">};</span>
  <span class="identifier">register_action</span><span class="special">(</span><span class="string">"FindDocument"</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">MyServer</span><span class="special">::</span><span class="identifier">FindDocument</span><span class="special">,</span> <span class="identifier">kFindDocumentParamNames</span><span class="special">);</span>
<span class="special">}</span>
</pre>
<p>
        We start the constructor by calling the constructor of our base class, <code class="computeroutput"><a class="link" href="../zeep/server.html" title="Class server">zeep::server</a></code>. We then continue by
        exporting the data types. Our MyHit datatype is exported under the name 'hit'
        and MyAlgorithm is exported as 'algorithm'. The various values of MyAlgorithm
        are exported under a new name as well.
      </p>
<p>
        After exporting the datatypes, we export the methods. We do this by calling
        <code class="computeroutput"><span class="identifier">register_action</span></code> specifying
        the parameters for the exported method name, the callback to make and the
        names for the parameters. And that's all. All that's left is to write a
        <code class="computeroutput"><span class="identifier">main</span></code>.
      </p>
<pre class="programlisting"><span class="keyword">int</span> <span class="identifier">main</span><span class="special">()</span>
<span class="special">{</span>
  <span class="identifier">MyServer</span> <span class="identifier">server</span><span class="special">;</span>
  <span class="identifier">server</span><span class="special">.</span><span class="identifier">bind</span><span class="special">(</span><span class="string">"0.0.0.0"</span><span class="special">,</span> <span class="number">80</span><span class="special">);</span>
  <span class="identifier">server</span><span class="special">.</span><span class="identifier">run</span><span class="special">(</span><span class="number">1</span><span class="special">);</span>
<span class="special">}</span>
</pre>
<p>
        And that will run our code in a single threaded server. If you run this code
        on your local machine you can test the REST versions of the code by visiting
        the following URL's with a web browser:
      </p>
<p>
        <a href="http://localhost/rest/CountDocuments" target="_top">http://localhost/rest/CountDocuments</a>
        Will return a SOAP envelope containing <span class="bold"><strong>1</strong></span>
        in a response element
      </p>
<p>
        <a href="http://localhost/rest/GetDocument/id/1" target="_top">http://localhost/rest/GetDocument/id/1</a>
      </p>
<p>
        <a href="http://localhost/rest/GetDocument/id/2" target="_top">http://localhost/rest/GetDocument/id/2</a>
        Will return a SOAP Fault
      </p>
<p>
        <a href="http://localhost/rest/FindDocument/terms/bla/algorithm/vector" target="_top">http://localhost/rest/FindDocument/terms/bla/algorithm/vector</a>
      </p>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2012-2019 Maarten L. Hekkelman<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="intro.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="webapp.html"><img src="../images/next.png" alt="Next"></a>
</div>
</body>
</html>
